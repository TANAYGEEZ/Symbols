<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"> 
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Default Light Theme (Fallback) */
            --bg-color: #f4f5f7; 
            --text-color: #1f2937; 
            --card-bg-color: white;
            --card-border-color: #e5e7eb; 
            --input-bg-color: white;
            --input-border-color: #d1d5db; 
            --input-text-color: #1f2937;
            --btn-primary-bg-color: #3b82f6; 
            --btn-primary-text-color: white;
            --btn-secondary-bg-color: #e5e7eb; 
            --btn-secondary-text-color: #374151; 
            --accent-color: #3b82f6;
            --label-text-color: #4b5563; 
            --header-text-color: #111827; 
            --digital-clock-text-color: #3b82f6;
            --digital-clock-shadow-color: #3b82f6;
            --current-date-text-color: #4b5563;
            --svg-icon-color: #4b5563;
            --modal-backdrop-color: rgba(0, 0, 0, 0.55); 
            --loading-spinner-color: #3b82f6;
            --theme-menu-bg: white;
            --theme-menu-text: #374151;
            --theme-menu-hover-bg: #f3f4f6;
            --theme-menu-shadow: rgba(0,0,0,0.1);
        }

        html.dark {
            /* Default Dark Theme (Fallback) - Will be overridden by specific dark themes */
            --bg-color: #0f172a; 
            --text-color: #e2e8f0; 
            --card-bg-color: #1e293b; 
            --card-border-color: #334155; 
            --input-bg-color: #334155; 
            --input-border-color: #475569; 
            --input-text-color: #e2e8f0;
            --btn-primary-bg-color: #60a5fa; 
            --btn-primary-text-color: #0f172a; 
            --btn-secondary-bg-color: #334155; 
            --btn-secondary-text-color: #e2e8f0;
            --accent-color: #60a5fa;
            --label-text-color: #94a3b8; 
            --header-text-color: #f1f5f9; 
            --digital-clock-text-color: #60a5fa;
            --digital-clock-shadow-color: #60a5fa;
            --current-date-text-color: #94a3b8;
            --svg-icon-color: #94a3b8;
            --modal-backdrop-color: rgba(0, 0, 0, 0.75); 
            --loading-spinner-color: #60a5fa;
            --theme-menu-bg: #1e293b;
            --theme-menu-text: #e2e8f0;
            --theme-menu-hover-bg: #334155;
            --theme-menu-shadow: rgba(0,0,0,0.25);
        }

        body {
            font-family: 'Inter', sans-serif; /* Default font */
            transition: background-color 0.35s ease-in-out, color 0.35s ease-in-out;
            background-color: var(--bg-color);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.6;
        }
        /* Theme specific body fonts */
        body.font-poppins { font-family: 'Poppins', sans-serif; }
        body.font-orbitron { font-family: 'Orbitron', monospace; } /* Orbitron is monospace-like */
        body.font-roboto { font-family: 'Roboto', sans-serif; }
        body.font-monospace { font-family: 'Orbitron', monospace; } /* Using Orbitron for general monospace needs */


        .card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--card-border-color);
            border-radius: 0.875rem; 
            box-shadow: 0 8px 16px -4px rgba(0,0,0,0.06), 0 3px 6px -3px rgba(0,0,0,0.04);
            padding: 1.25rem 1.75rem;
            transition: background-color 0.35s ease-in-out, border-color 0.35s ease-in-out, box-shadow 0.35s ease-in-out;
        }
        html.dark .card {
            box-shadow: 0 8px 16px -4px rgba(0,0,0,0.12), 0 3px 6px -3px rgba(0,0,0,0.08);
        }
        /* Glassmorphism style for cards in specific theme */
        html.dark.theme-slate-glass .card, 
        html.dark.theme-slate-glass .clock-section-wrapper,
        html.dark.theme-slate-glass .modal-content { /* Apply to new slate glass theme cards */
            background-color: color-mix(in srgb, var(--card-bg-color) 70%, transparent);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid color-mix(in srgb, var(--card-border-color) 50%, transparent);
        }


        .form-input, .form-select {
            width: 100%;
            padding: 0.625rem 0.875rem; 
            border: 1px solid var(--input-border-color);
            background-color: var(--input-bg-color);
            color: var(--input-text-color);
            border-radius: 0.625rem; 
            transition: border-color 0.25s ease-in-out, box-shadow 0.25s ease-in-out, background-color 0.35s ease-in-out, color 0.35s ease-in-out;
            font-size: 0.9375rem; 
        }
        
        .form-select { /* Used for format selection - custom arrow removed */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
             padding-right: 0.875rem; 
        }


        .form-input:hover, .form-select:hover {
            border-color: color-mix(in srgb, var(--input-border-color) 60%, var(--accent-color) 40%);
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            appearance: textfield;
            -moz-appearance: textfield; 
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3.5px color-mix(in srgb, var(--accent-color) 20%, transparent); 
        }
        
        .label-text { color: var(--label-text-color); font-weight: 500; }
        .header-text { color: var(--header-text-color); font-weight: 700; }

        .btn {
            padding: 0.625rem 1.125rem; 
            border-radius: 0.625rem; 
            font-weight: 600; 
            transition: background-color 0.25s ease-out, color 0.25s ease-out, transform 0.15s cubic-bezier(0.25, 0.1, 0.25, 1), box-shadow 0.25s ease-out;
            cursor: pointer;
            border: none;
            display: inline-flex; 
            align-items: center;
            justify-content: center; 
            gap: 0.625rem; 
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.07), 0 1px 2px -1px rgba(0,0,0,0.04);
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px -3px rgba(0,0,0,0.1), 0 3px 7px -3px rgba(0,0,0,0.07);
        }
        .btn:active:not(:disabled) { 
            transform: translateY(-1px); 
            box-shadow: 0 2px 4px -2px rgba(0,0,0,0.08), 0 1px 2px -1px rgba(0,0,0,0.05);
        }
        .btn:disabled {
            opacity: 0.45; 
            cursor: not-allowed;
        }
        .btn svg {
            width: 1.125rem; 
            height: 1.125rem; 
        }

        .btn-primary {
            background-color: var(--btn-primary-bg-color);
            color: var(--btn-primary-text-color);
        }
        .btn-primary:hover:not(:disabled) { 
            background-color: color-mix(in srgb, var(--btn-primary-bg-color) 88%, black);
        }
        html.dark .btn-primary:hover:not(:disabled) { 
            background-color: color-mix(in srgb, var(--btn-primary-bg-color) 88%, white);
        }
        
        .btn-secondary {
            background-color: var(--btn-secondary-bg-color);
            color: var(--btn-secondary-text-color);
            border: 1px solid var(--card-border-color);
        }
        .btn-secondary:hover:not(:disabled) { 
            background-color: color-mix(in srgb, var(--btn-secondary-bg-color) 88%, var(--text-color) 5%);
        }
         html.dark .btn-secondary:hover:not(:disabled) { 
            background-color: color-mix(in srgb, var(--btn-secondary-bg-color) 88%, var(--text-color) 10%);
            border-color: color-mix(in srgb, var(--card-border-color) 75%, white);
        }

        /* Graphite Steel Buttons */
        html.dark.theme-graphite-steel .btn-primary {
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.4), inset -1px -1px 2px color-mix(in srgb, var(--card-bg-color) 150%, black);
            border: 1px solid color-mix(in srgb, var(--accent-color) 60%, black);
            background-color: var(--accent-color);
            color: var(--text-color);
        }
        html.dark.theme-graphite-steel .btn-primary:hover:not(:disabled) {
            box-shadow: inset 2px 2px 3px rgba(0,0,0,0.5), inset -2px -2px 3px color-mix(in srgb, var(--card-bg-color) 160%, black);
            background-color: color-mix(in srgb, var(--accent-color) 90%, black);
        }
         html.dark.theme-graphite-steel .btn-secondary {
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.4), inset -1px -1px 2px color-mix(in srgb, var(--card-bg-color) 150%, black);
            border: 1px solid color-mix(in srgb, var(--btn-secondary-text-color) 40%, black);
        }


        /* Gunmetal Dark Buttons */
        html.dark.theme-gunmetal-dark .btn { border: none !important; }
        html.dark.theme-gunmetal-dark .btn-primary {
            background-color: var(--accent-color) !important; 
            color: var(--bg-color) !important; 
        }
        html.dark.theme-gunmetal-dark .btn-primary:hover:not(:disabled) {
            background-color: color-mix(in srgb, var(--accent-color) 85%, black) !important;
        }
        html.dark.theme-gunmetal-dark .btn-secondary {
             background-color: color-mix(in srgb, var(--btn-secondary-bg-color) 80%, var(--text-color) 10%) !important;
             color: var(--text-color) !important;
        }
          html.dark.theme-gunmetal-dark .btn-secondary:hover:not(:disabled) {
             background-color: color-mix(in srgb, var(--btn-secondary-bg-color) 70%, var(--text-color) 15%) !important;
        }


        /* Obsidian Core Buttons */
        html.dark.theme-obsidian-core .btn { border: none !important; }
        html.dark.theme-obsidian-core .btn-primary {
            background-color: var(--accent-color) !important;
            color: var(--bg-color) !important; /* Text color for button */
        }
        html.dark.theme-obsidian-core .btn-primary:hover:not(:disabled) {
            box-shadow: 0 0 7px var(--accent-color), 0 0 10px color-mix(in srgb, var(--accent-color) 50%, transparent);
            background-color: color-mix(in srgb, var(--accent-color) 90%, white) !important;
        }
         html.dark.theme-obsidian-core .btn-secondary {
            background-color: var(--btn-secondary-bg-color) !important;
            color: var(--text-color) !important;
        }
        html.dark.theme-obsidian-core .btn-secondary:hover:not(:disabled) {
            box-shadow: 0 0 7px var(--btn-secondary-text-color), 0 0 10px color-mix(in srgb, var(--btn-secondary-text-color) 30%, transparent);
            background-color: color-mix(in srgb, var(--btn-secondary-bg-color) 90%, white) !important;
        }

        /* Slate Glass Buttons */
        html.dark.theme-slate-glass .btn { 
            background-color: color-mix(in srgb, var(--card-bg-color) 60%, transparent) !important; 
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid color-mix(in srgb, var(--accent-color) 30%, transparent) !important;
            color: var(--text-color) !important;
        }
        html.dark.theme-slate-glass .btn-primary:hover:not(:disabled) {
            background-color: color-mix(in srgb, var(--accent-color) 30%, transparent) !important;
            border-color: var(--accent-color) !important;
        }
        html.dark.theme-slate-glass .btn-secondary:hover:not(:disabled) {
            background-color: color-mix(in srgb, var(--btn-secondary-bg-color) 40%, transparent) !important;
            border-color: color-mix(in srgb, var(--card-border-color) 70%, white) !important;
        }

        /* Terminal Retro-Modern Buttons & Text */
        html.dark.theme-terminal-retro-modern .btn {
            border-radius: 0.375rem; 
            border: 1px solid var(--accent-color) !important;
            background-color: var(--bg-color) !important;
            color: var(--accent-color) !important;
            box-shadow: 0 2px 0 var(--accent-color); 
        }
        html.dark.theme-terminal-retro-modern .btn:hover:not(:disabled) {
            background-color: color-mix(in srgb, var(--accent-color) 10%, black) !important;
            box-shadow: 0 1px 0 var(--accent-color);
            transform: translateY(1px);
        }
        html.dark.theme-terminal-retro-modern .btn:active:not(:disabled) {
            box-shadow: none;
            transform: translateY(2px);
        }
        html.dark.theme-terminal-retro-modern .label-text,
        html.dark.theme-terminal-retro-modern .header-text,
        html.dark.theme-terminal-retro-modern .current-date-display,
        html.dark.theme-terminal-retro-modern .age-label,
        html.dark.theme-terminal-retro-modern .form-input::placeholder {
            color: var(--accent-color) !important; 
            opacity: 0.9;
        }
         html.dark.theme-terminal-retro-modern .form-input,
         html.dark.theme-terminal-retro-modern .form-select {
            color: var(--accent-color) !important;
            border-color: color-mix(in srgb, var(--accent-color) 60%, transparent) !important;
            background-color: color-mix(in srgb, var(--bg-color) 85%, black) !important;
         }
        html.dark.theme-terminal-retro-modern .age-value,
        html.dark.theme-terminal-retro-modern .digital-clock { 
             color: var(--accent-color) !important;
        }
        html.dark.theme-terminal-retro-modern .svg-icon-color {
            color: var(--accent-color) !important;
        }


        .age-result-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(75px, 1fr)); 
            gap: 0.625rem; 
            text-align: center;
            margin-top: 1.25rem; 
        }
        .age-block { 
            background-color: color-mix(in srgb, var(--card-bg-color) 90%, var(--bg-color) 10%);
            padding: 0.625rem; 
            border-radius: 0.625rem; 
            border: 1px solid var(--card-border-color);
            opacity: 1; 
        }
        .age-value {
            display: block;
            font-size: clamp(1.125rem, 3.5vw, 1.625rem); 
            font-weight: 700;
            line-height: 1.25;
            color: var(--accent-color);
        }
        .age-label {
            display: block;
            font-size: 0.6875rem; 
            color: var(--label-text-color);
            margin-top: 0.125rem; 
            font-weight: 500;
        }

        .clock-section-wrapper { 
            background-color: var(--card-bg-color);
            border: 1px solid var(--card-border-color);
            border-radius: 0.875rem;
            box-shadow: 0 3px 5px -1px rgba(0,0,0,0.04), 0 1px 3px -1px rgba(0,0,0,0.03);
            padding: 0.75rem 1rem; 
            text-align: center;
            width: 100%;
            max-width: 320px; 
            margin: 0.75rem auto 0; 
        }
         html.dark .clock-section-wrapper {
            box-shadow: 0 3px 5px -1px rgba(0,0,0,0.08), 0 1px 3px -1px rgba(0,0,0,0.06);
        }


        .current-date-display {
            font-family: 'Inter', sans-serif;
            font-size: clamp(0.8rem, 2vw, 0.9375rem); 
            color: var(--current-date-text-color);
            margin-bottom: 0.1rem; 
            font-weight: 500;
        }
        .digital-clock {
            font-family: 'Orbitron', monospace;
            font-size: clamp(1.5rem, 6vw, 2.25rem); /* Increased size */
            color: var(--digital-clock-text-color);
            text-shadow: 0 0 2px color-mix(in srgb, var(--digital-clock-shadow-color) 35%, transparent), 0 0 4px color-mix(in srgb, var(--digital-clock-shadow-color) 15%, transparent);
            letter-spacing: 0.25px;
            padding: 0.1rem 0; 
            font-weight: 500;
        }
        /* Specific theme adjustments for clock */
        html.dark.theme-neo-noir-cyberpunk .digital-clock { /* Kept for existing theme if it's re-added */
            text-shadow: 0 0 3px var(--accent-color), 0 0 6px var(--accent-color), 0 0 9px color-mix(in srgb, var(--accent-color) 50%, transparent);
        }


        .theme-controls {
            position: fixed;
            top: 0.75rem; 
            right: 0.75rem; 
            z-index: 1000; 
        }
        .theme-button {
            background-color: var(--card-bg-color);
            color: var(--svg-icon-color);
            padding: 0.5rem; 
            border-radius: 0.5rem; 
            border: 1px solid var(--card-border-color);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .theme-button:hover {
            background-color: color-mix(in srgb, var(--card-bg-color) 90%, var(--accent-color) 10%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.07);
        }
        .theme-button svg {
            width: 1.25rem; 
            height: 1.25rem; 
        }

        #themeMenu {
            position: absolute;
            right: 0;
            top: calc(100% + 0.5rem); 
            background-color: var(--theme-menu-bg);
            border-radius: 0.5rem; 
            box-shadow: 0 4px 12px var(--theme-menu-shadow);
            border: 1px solid var(--card-border-color);
            width: max-content; 
            min-width: 180px; 
            z-index: 1001;
            opacity: 0;
            transform: translateY(-10px) scale(0.95);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            pointer-events: none;
        }
        #themeMenu.active {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }
        .theme-option {
            display: block;
            padding: 0.625rem 1rem; 
            font-size: 0.875rem; 
            color: var(--theme-menu-text);
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
            white-space: nowrap;
        }
        .theme-option:hover {
            background-color: var(--theme-menu-hover-bg);
        }
        .theme-option:first-child { border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem;}
        .theme-option:last-child { border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem;}


        .modal {
            background-color: var(--modal-backdrop-color);
            z-index: 999; 
            transition: opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal-content {
            max-height: 90vh; 
            overflow-y: auto;
            transform: scale(0.92) translateY(10px); 
            opacity: 0;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal:not(.hidden) .modal-content {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
        
        *:focus-visible { 
            outline: 3px solid var(--accent-color);
            outline-offset: 2px;
            box-shadow: 0 0 0 5px color-mix(in srgb, var(--accent-color) 15%, transparent);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-3 sm:p-6">

    <div class="theme-controls">
        <div class="relative"> <button id="themeToggleButton" class="theme-button" aria-label="Select theme">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 1 1 0-4 2 2 0 0 1 0 4ZM10 12a2 2 0 1 1 0-4 2 2 0 0 1 0 4ZM10 18a2 2 0 1 1 0-4 2 2 0 0 1 0 4Z"></path></svg>
            </button>
            <div id="themeMenu" class="py-1">
                </div>
        </div>
    </div>

    <header class="text-center w-full py-5 sm:py-6 mb-1 sm:mb-3">
        <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold header-text">AgeX</h1>
        <div class="clock-section-wrapper mt-3 sm:mt-4">
            <div id="currentDateDisplay" class="current-date-display">Loading Date...</div>
            <div id="digitalClock" class="digital-clock">00:00:00 AM</div>
        </div>
    </header>

    <main class="w-full max-w-md sm:max-w-lg lg:max-w-xl mx-auto flex-grow space-y-3 sm:space-y-5">
        <section class="card">
            <h2 class="text-md sm:text-lg font-semibold mb-3 sm:mb-4 header-text">Enter Your Date & Time of Birth</h2>
            <div class="grid grid-cols-3 gap-2 sm:gap-3 items-end mb-2 sm:mb-3">
                <div>
                    <label for="dobDay" class="block text-xs sm:text-sm font-medium label-text mb-1">Day</label>
                    <input type="number" id="dobDay" class="form-input" placeholder="DD" min="1" max="31" maxlength="2">
                </div>
                <div>
                    <label for="dobMonth" class="block text-xs sm:text-sm font-medium label-text mb-1">Month (1-12)</label>
                    <input type="number" id="dobMonth" class="form-input" placeholder="MM" min="1" max="12" maxlength="2">
                </div>
                <div>
                    <label for="dobYear" class="block text-xs sm:text-sm font-medium label-text mb-1">Year</label>
                    <input type="number" id="dobYear" class="form-input" placeholder="YYYY" min="1" max="9999" maxlength="4">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-2 sm:gap-3 items-end">
                <div>
                    <label for="dobHour" class="block text-xs sm:text-sm font-medium label-text mb-1">Hour (0-23)</label>
                    <input type="number" id="dobHour" class="form-input" placeholder="HH" min="0" max="23" maxlength="2">
                </div>
                <div>
                    <label for="dobMinute" class="block text-xs sm:text-sm font-medium label-text mb-1">Minute (0-59)</label>
                    <input type="number" id="dobMinute" class="form-input" placeholder="MM" min="0" max="59" maxlength="2">
                </div>
            </div>
        </section>

        <section class="card">
            <label for="formatSelect" class="block text-xs sm:text-sm font-medium label-text mb-1">Show Age In</label>
            <select id="formatSelect" class="form-select">
                <option value="YMDHMS">Years, Months, Days, Hours, Minutes, Seconds</option>
                <option value="YDHMS">Years, Days, Hours, Minutes, Seconds</option> 
                <option value="MDHMS">Months, Days, Hours, Minutes, Seconds</option> 
                <option value="WDHMS">Weeks, Days, Hours, Minutes, Seconds</option>
                <option value="DHMS">Days, Hours, Minutes, Seconds</option>
                <option value="HMS">Hours, Minutes, Seconds</option>
                <option value="MS">Minutes, Seconds</option>
                <option value="S">Seconds</option>
            </select>
        </section>

        <section class="card">
            <h2 class="text-md sm:text-lg font-semibold mb-1 sm:mb-2 header-text">Your Age Is</h2>
            <div id="ageResult" class="age-result-container min-h-[65px] sm:min-h-[75px]">
                <p class="text-center label-text col-span-full py-3 sm:py-4">Select your full date and time of birth to see your age.</p>
            </div>
        </section>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-3 mt-3 sm:mt-5">
            <button id="resetButton" class="btn btn-secondary w-full text-sm sm:text-base">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.323 4.677a7.5 7.5 0 0 0-10.606 0L3.75 5.643A.75.75 0 0 0 3 6.393V9.75a.75.75 0 0 0 .75.75H7.5a.75.75 0 0 0 .53-1.28l-.97-.971A5.25 5.25 0 0 1 12.75 6a.75.75 0 0 0 1.06-.09l.255-.34A7.5 7.5 0 0 0 15.323 4.677ZM2.677 15.323a7.5 7.5 0 0 0 10.606 0l.964-.964a.75.75 0 0 0 .217-.53V10.5a.75.75 0 0 0-.75-.75H9.75a.75.75 0 0 0-.53 1.28l.97.97A5.25 5.25 0 0 1 7.25 14a.75.75 0 0 0-1.06.09l-.255.34A7.5 7.5 0 0 0 2.677 15.323Z" clip-rule="evenodd" /></svg>
                Reset
            </button>
            <button id="openDateDifferenceModalButton" class="btn btn-primary w-full text-sm sm:text-base">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm.75-13a.75.75 0 0 0-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 0 0 0-1.5h-3.25V5Z" clip-rule="evenodd" /></svg>
                Time Between
            </button>
            <button id="openCountdownModalButton" class="btn btn-primary w-full text-sm sm:text-base">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 1a9 9 0 1 0 0 18 9 9 0 0 0 0-18ZM8.27 5.993c0-.414.336-.75.75-.75h2.961c.414 0 .75.336.75.75v1.017a.75.75 0 0 0 1.234.573l.31-.31A.75.75 0 0 1 15 7.53v2.961a.75.75 0 0 1-.252.53l-.31.31a.75.75 0 0 0-.573 1.234h1.017c.414 0 .75.336.75.75v2.961a.75.75 0 0 1-.75.75H11.73a.75.75 0 0 0-.573 1.234l.31.31a.75.75 0 0 1 .252.53V17.5a.75.75 0 0 1-.75.75H7.52a.75.75 0 0 1-.53-.252l-.31-.31a.75.75 0 0 0-1.234-.573V15.27a.75.75 0 0 0-.75-.75H3.5a.75.75 0 0 1-.75-.75V10.81a.75.75 0 0 1 .75-.75h1.017a.75.75 0 0 0 .573-1.234l-.31-.31A.75.75 0 0 1 4.52 8.27V5.309a.75.75 0 0 1 .75-.75h2.961a.75.75 0 0 0 .53-.252l.31-.31a.75.75 0 0 1 1.234-.573V5.993Z" /></svg>
                Countdown
            </button>
        </div>
        
    </main>

    <footer class="w-full max-w-md sm:max-w-lg lg:max-w-xl mx-auto mt-5 sm:mt-7 py-3 sm:py-5">
        </footer>

    <div id="dateDifferenceModal" class="modal hidden fixed inset-0 flex items-center justify-center p-3 sm:p-4">
        <div class="modal-content card w-full max-w-md sm:max-w-lg"> 
            <div class="flex justify-between items-center mb-3 sm:mb-4">
                <h2 class="text-md sm:text-lg font-semibold header-text">Calculate Time Between Two Dates</h2>
                <button id="closeDateDifferenceModalButton" class="text-2xl font-bold hover:opacity-75 transition-opacity duration-200" style="color: var(--svg-icon-color);" aria-label="Close date difference modal">&times;</button>
            </div>

            <section class="mb-2 sm:mb-3">
                <h3 class="text-sm sm:text-base font-medium mb-1 sm:mb-2 label-text">Start Date</h3>
                <div class="grid grid-cols-3 gap-2 sm:gap-3 items-end">
                    <div>
                        <label for="startDateDay" class="block text-xs sm:text-sm font-medium label-text mb-0.5 sm:mb-1">Day</label>
                        <input type="number" id="startDateDay" class="form-input" placeholder="DD" min="1" max="31" maxlength="2">
                    </div>
                    <div>
                        <label for="startDateMonth" class="block text-xs sm:text-sm font-medium label-text mb-0.5 sm:mb-1">Month (1-12)</label>
                        <input type="number" id="startDateMonth" class="form-input" placeholder="MM" min="1" max="12" maxlength="2">
                    </div>
                    <div>
                        <label for="startDateYear" class="block text-xs sm:text-sm font-medium label-text mb-0.5 sm:mb-1">Year</label>
                        <input type="number" id="startDateYear" class="form-input" placeholder="YYYY" min="1" max="9999" maxlength="4">
                    </div>
                </div>
            </section>

            <section class="mb-3 sm:mb-4">
                <h3 class="text-sm sm:text-base font-medium mb-1 sm:mb-2 label-text">End Date</h3>
                <div class="grid grid-cols-3 gap-2 sm:gap-3 items-end">
                    <div>
                        <label for="endDateDay" class="block text-xs sm:text-sm font-medium label-text mb-0.5 sm:mb-1">Day</label>
                        <input type="number" id="endDateDay" class="form-input" placeholder="DD" min="1" max="31" maxlength="2">
                    </div>
                    <div>
                        <label for="endDateMonth" class="block text-xs sm:text-sm font-medium label-text mb-0.5 sm:mb-1">Month (1-12)</label>
                        <input type="number" id="endDateMonth" class="form-input" placeholder="MM" min="1" max="12" maxlength="2">
                    </div>
                    <div>
                        <label for="endDateYear" class="block text-xs sm:text-sm font-medium label-text mb-0.5 sm:mb-1">Year</label>
                        <input type="number" id="endDateYear" class="form-input" placeholder="YYYY" min="1" max="9999" maxlength="4">
                    </div>
                </div>
            </section>

            <section class="mb-2 sm:mb-3">
                <label for="differenceFormatSelect" class="block text-xs sm:text-sm font-medium label-text mb-1">Show Difference In</label>
                <select id="differenceFormatSelect" class="form-select">
                    <option value="YMDHMS">Years, Months, Days, Hours, Minutes, Seconds</option>
                    <option value="YDHMS">Years, Days, Hours, Minutes, Seconds</option> 
                    <option value="MDHMS">Months, Days, Hours, Minutes, Seconds</option> 
                    <option value="WDHMS">Weeks, Days, Hours, Minutes, Seconds</option>
                    <option value="DHMS">Days, Hours, Minutes, Seconds</option>
                    <option value="HMS">Hours, Minutes, Seconds</option>
                    <option value="MS">Minutes, Seconds</option>
                    <option value="S">Seconds</option>
                </select>
            </section>

            <div class="text-center mb-2 sm:mb-3">
                 <button id="resetDateDifferenceButton" class="btn btn-secondary text-sm sm:text-base">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.323 4.677a7.5 7.5 0 0 0-10.606 0L3.75 5.643A.75.75 0 0 0 3 6.393V9.75a.75.75 0 0 0 .75.75H7.5a.75.75 0 0 0 .53-1.28l-.97-.971A5.25 5.25 0 0 1 12.75 6a.75.75 0 0 0 1.06-.09l.255-.34A7.5 7.5 0 0 0 15.323 4.677ZM2.677 15.323a7.5 7.5 0 0 0 10.606 0l.964-.964a.75.75 0 0 0 .217-.53V10.5a.75.75 0 0 0-.75-.75H9.75a.75.75 0 0 0-.53 1.28l.97.97A5.25 5.25 0 0 1 7.25 14a.75.75 0 0 0-1.06.09l-.255.34A7.5 7.5 0 0 0 2.677 15.323Z" clip-rule="evenodd" /></svg>
                    Reset
                </button>
            </div>

            <section>
                <h3 class="text-sm sm:text-base font-semibold mb-1 sm:mb-2 header-text">Time Difference Is</h3>
                <div id="dateDifferenceResult" class="age-result-container min-h-[65px] sm:min-h-[75px]">
                    <p class="text-center label-text col-span-full py-3 sm:py-4">Enter two valid dates to see the difference.</p>
                </div>
            </section>
        </div>
    </div>

    <div id="countdownModal" class="modal hidden fixed inset-0 flex items-center justify-center p-3 sm:p-4">
        <div class="modal-content card w-full max-w-md sm:max-w-lg">
            <div class="flex justify-between items-center mb-3 sm:mb-4">
                <h2 class="text-md sm:text-lg font-semibold header-text">Countdown to a Future Date & Time</h2>
                <button id="closeCountdownModalButton" class="text-2xl font-bold hover:opacity-75 transition-opacity duration-200" style="color: var(--svg-icon-color);" aria-label="Close countdown modal">&times;</button>
            </div>
            <div class="grid grid-cols-3 gap-2 sm:gap-3 items-end mb-2 sm:mb-3">
                <div>
                    <label for="futureDateDayModal" class="block text-xs sm:text-sm font-medium label-text mb-0.5 sm:mb-1">Day</label>
                    <input type="number" id="futureDateDayModal" class="form-input" placeholder="DD" min="1" max="31" maxlength="2">
                </div>
                <div>
                    <label for="futureDateMonthInputModal" class="block text-xs sm:text-sm font-medium label-text mb-0.5 sm:mb-1">Month (1-12)</label>
                    <input type="number" id="futureDateMonthInputModal" class="form-input" placeholder="MM" min="1" max="12" maxlength="2">
                </div>
                <div>
                    <label for="futureDateYearModal" class="block text-xs sm:text-sm font-medium label-text mb-0.5 sm:mb-1">Year</label>
                    <input type="number" id="futureDateYearModal" class="form-input" placeholder="YYYY" min="1" max="9999" maxlength="4">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-2 sm:gap-3 items-end mb-2 sm:mb-3">
                <div>
                    <label for="futureTimeHourInputModal" class="block text-xs sm:text-sm font-medium label-text mb-0.5 sm:mb-1">Hour (0-23)</label>
                    <input type="number" id="futureTimeHourInputModal" class="form-input" placeholder="HH" min="0" max="23" maxlength="2">
                </div>
                <div>
                    <label for="futureTimeMinuteInputModal" class="block text-xs sm:text-sm font-medium label-text mb-0.5 sm:mb-1">Minute (0-59)</label>
                    <input type="number" id="futureTimeMinuteInputModal" class="form-input" placeholder="MM" min="0" max="59" maxlength="2">
                </div>
            </div>

            <div class="mb-2 sm:mb-3">
                <label for="countdownFormatSelectModal" class="block text-xs sm:text-sm font-medium label-text mb-1">Show Countdown In</label>
                <select id="countdownFormatSelectModal" class="form-select">
                    <option value="YMDHMS">Years, Months, Days, Hours, Minutes, Seconds</option>
                    <option value="YDHMS">Years, Days, Hours, Minutes, Seconds</option> 
                    <option value="MDHMS">Months, Days, Hours, Minutes, Seconds</option> 
                    <option value="WDHMS">Weeks, Days, Hours, Minutes, Seconds</option>
                    <option value="DHMS">Days, Hours, Minutes, Seconds</option>
                    <option value="HMS">Hours, Minutes, Seconds</option>
                    <option value="MS">Minutes, Seconds</option>
                    <option value="S">Seconds</option>
                </select>
            </div>
            <div id="countdownResultModal" class="age-result-container min-h-[65px] sm:min-h-[75px] mb-2 sm:mb-3">
                <p class="text-center label-text col-span-full py-3 sm:py-4">Enter a future date and time to start the countdown.</p>
            </div>
            <div class="text-center">
                <button id="resetCountdownModalButton" class="btn btn-secondary w-full sm:w-auto text-sm sm:text-base">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.323 4.677a7.5 7.5 0 0 0-10.606 0L3.75 5.643A.75.75 0 0 0 3 6.393V9.75a.75.75 0 0 0 .75.75H7.5a.75.75 0 0 0 .53-1.28l-.97-.971A5.25 5.25 0 0 1 12.75 6a.75.75 0 0 0 1.06-.09l.255-.34A7.5 7.5 0 0 0 15.323 4.677ZM2.677 15.323a7.5 7.5 0 0 0 10.606 0l.964-.964a.75.75 0 0 0 .217-.53V10.5a.75.75 0 0 0-.75-.75H9.75a.75.75 0 0 0-.53 1.28l.97.97A5.25 5.25 0 0 1 7.25 14a.75.75 0 0 0-1.06.09l-.255.34A7.5 7.5 0 0 0 2.677 15.323Z" clip-rule="evenodd" /></svg>
                    Reset Countdown
                </button>
            </div>
        </div>
    </div>


    <script>
    // Declare DOM element variables - will be assigned in DOMContentLoaded
    let dobDayInput, dobMonthInput, dobYearInput, dobHourInput, dobMinuteInput, 
        formatSelect, ageResultDiv, digitalClockDiv, currentDateDiv,
        resetButton, openDateDifferenceModalButton,
        dateDifferenceModal, closeDateDifferenceModalButton, startDateDayInput,
        startDateMonthInput, startDateYearInput, endDateDayInput, 
        endDateMonthInput, endDateYearInput, resetDateDifferenceButton, 
        dateDifferenceResultDiv, differenceFormatSelect,
        openCountdownModalButton, countdownModal, closeCountdownModalButton,
        futureDateDayInputModal, futureDateMonthInputModal, futureDateYearInputModal, 
        futureTimeHourInputModal, futureTimeMinuteInputModal,
        countdownFormatSelectModal, countdownResultModalDiv,
        resetCountdownModalButton,
        themeToggleButton, themeMenu;
    
    // Store the start date for difference calculations to help with YDHMS format
    let startDateForDifferenceModal; 


    // Global state
    let ageCalculationInterval = null;
    let birthDateTime = null;
    let differenceCalculationInterval = null; 
    let futureDateTimeModal = null; 
    let countdownModalInterval = null; 

    const root = document.documentElement;
    
    // --- Theme Definitions (Updated & New Themes Added) ---
    const themes = {
        "default-light": { name: "Default Light", isDark: false, font: 'Inter', colors: { "--bg-color": "#f4f5f7", "--text-color": "#1f2937", "--card-bg-color": "white", "--card-border-color": "#e5e7eb", "--input-bg-color": "white", "--input-border-color": "#d1d5db", "--input-text-color": "#1f2937", "--btn-primary-bg-color": "#3b82f6", "--btn-primary-text-color": "white", "--btn-secondary-bg-color": "#e5e7eb", "--btn-secondary-text-color": "#374151", "--accent-color": "#3b82f6", "--label-text-color": "#4b5563", "--header-text-color": "#111827", "--digital-clock-text-color": "#3b82f6", "--digital-clock-shadow-color": "#3b82f6", "--current-date-text-color": "#4b5563", "--svg-icon-color": "#4b5563", "--modal-backdrop-color": "rgba(0,0,0,0.55)", "--loading-spinner-color": "#3b82f6", "--theme-menu-bg": "white", "--theme-menu-text": "#374151", "--theme-menu-hover-bg": "#f3f4f6", "--theme-menu-shadow": "rgba(0,0,0,0.1)" }},
        "default-dark": { name: "Default Dark", isDark: true, font: 'Inter', colors: { "--bg-color": "#0f172a", "--text-color": "#e2e8f0", "--card-bg-color": "#1e293b", "--card-border-color": "#334155", "--input-bg-color": "#334155", "--input-border-color": "#475569", "--input-text-color": "#e2e8f0", "--btn-primary-bg-color": "#60a5fa", "--btn-primary-text-color": "#0f172a", "--btn-secondary-bg-color": "#334155", "--btn-secondary-text-color": "#e2e8f0", "--accent-color": "#60a5fa", "--label-text-color": "#94a3b8", "--header-text-color": "#f1f5f9", "--digital-clock-text-color": "#60a5fa", "--digital-clock-shadow-color": "#60a5fa", "--current-date-text-color": "#94a3b8", "--svg-icon-color": "#94a3b8", "--modal-backdrop-color": "rgba(0,0,0,0.75)", "--loading-spinner-color": "#60a5fa", "--theme-menu-bg": "#1e293b", "--theme-menu-text": "#e2e8f0", "--theme-menu-hover-bg": "#334155", "--theme-menu-shadow": "rgba(0,0,0,0.25)" }},
        "graphite-gold-dark": { name: "Graphite Gold Dark", isDark: true, font: 'Poppins', colors: { "--bg-color": "#1e293b", "--text-color": "#e2e8f0", "--card-bg-color": "#334155", "--card-border-color": "#475569", "--input-bg-color": "#475569", "--input-border-color": "#64748b", "--input-text-color": "#e2e8f0", "--btn-primary-bg-color": "#facc15", "--btn-primary-text-color": "#1e293b", "--btn-secondary-bg-color": "#475569", "--btn-secondary-text-color": "#e2e8f0", "--accent-color": "#facc15", "--label-text-color": "#94a3b8", "--header-text-color": "#f1f5f9", "--digital-clock-text-color": "#eab308", "--digital-clock-shadow-color": "#facc15", "--current-date-text-color": "#94a3b8", "--svg-icon-color": "#94a3b8", "--modal-backdrop-color": "rgba(0,0,0,0.7)", "--loading-spinner-color": "#facc15", "--theme-menu-bg": "#334155", "--theme-menu-text": "#e2e8f0", "--theme-menu-hover-bg": "#475569", "--theme-menu-shadow": "rgba(0,0,0,0.2)" }},
        "carbon-matte": { name: "Carbon Matte", isDark: true, font: 'Roboto', colors: { "--bg-color": "#000000", "--text-color": "#C0C0C0", "--card-bg-color": "#1C1C1C", "--card-border-color": "#333333", "--input-bg-color": "#1C1C1C", "--input-border-color": "#333333", "--input-text-color": "#C0C0C0", "--btn-primary-bg-color": "#FF6F00", "--btn-primary-text-color": "#000000", "--btn-secondary-bg-color": "#2C2C2C", "--btn-secondary-text-color": "#C0C0C0", "--accent-color": "#FF6F00", "--label-text-color": "#A0A0A0", "--header-text-color": "#C0C0C0", "--digital-clock-text-color": "#FF6F00", "--digital-clock-shadow-color": "#FF6F00", "--current-date-text-color": "#A0A0A0", "--svg-icon-color": "#A0A0A0", "--modal-backdrop-color": "rgba(0,0,0,0.65)", "--loading-spinner-color": "#FF6F00", "--theme-menu-bg": "#1C1C1C", "--theme-menu-text": "#C0C0C0", "--theme-menu-hover-bg": "#333333", "--theme-menu-shadow": "rgba(0,0,0,0.2)" }},
        "graphite-steel": { name: "Graphite Steel", isDark: true, font: 'Roboto', className: 'theme-graphite-steel', colors: { "--bg-color": "#1B1B1B", "--text-color": "#D3D3D3", "--card-bg-color": "#2B2B2B", "--card-border-color": "#444444", "--input-bg-color": "#2B2B2B", "--input-border-color": "#444444", "--input-text-color": "#D3D3D3", "--btn-primary-bg-color": "#B0BEC5", "--btn-primary-text-color": "#1B1B1B", "--btn-secondary-bg-color": "#4A4A4A", "--btn-secondary-text-color": "#D3D3D3", "--accent-color": "#B0BEC5", "--label-text-color": "#BDBDBD", "--header-text-color": "#D3D3D3", "--digital-clock-text-color": "#B0BEC5", "--digital-clock-shadow-color": "#B0BEC5", "--current-date-text-color": "#BDBDBD", "--svg-icon-color": "#BDBDBD", "--modal-backdrop-color": "rgba(0,0,0,0.7)", "--loading-spinner-color": "#B0BEC5", "--theme-menu-bg": "#2B2B2B", "--theme-menu-text": "#D3D3D3", "--theme-menu-hover-bg": "#444444", "--theme-menu-shadow": "rgba(0,0,0,0.25)" }},
        "gunmetal-dark": { name: "Gunmetal Dark", isDark: true, font: 'Poppins', className: 'theme-gunmetal-dark', colors: { "--bg-color": "#2A2D34", "--text-color": "#F5F5F5", "--card-bg-color": "#3A3F4B", "--card-border-color": "#505662", "--input-bg-color": "#3A3F4B", "--input-border-color": "#505662", "--input-text-color": "#F5F5F5", "--btn-primary-bg-color": "#D65A31", "--btn-primary-text-color": "#2A2D34", "--btn-secondary-bg-color": "#505662", "--btn-secondary-text-color": "#F5F5F5", "--accent-color": "#D65A31", "--label-text-color": "#CCCCCC", "--header-text-color": "#F5F5F5", "--digital-clock-text-color": "#D65A31", "--digital-clock-shadow-color": "#D65A31", "--current-date-text-color": "#CCCCCC", "--svg-icon-color": "#CCCCCC", "--modal-backdrop-color": "rgba(0,0,0,0.75)", "--loading-spinner-color": "#D65A31", "--theme-menu-bg": "#3A3F4B", "--theme-menu-text": "#F5F5F5", "--theme-menu-hover-bg": "#505662", "--theme-menu-shadow": "rgba(0,0,0,0.3)" }},
        "obsidian-core": { name: "Obsidian Core", isDark: true, font: 'Orbitron', className: 'theme-obsidian-core', colors: { "--bg-color": "#090C0F", "--text-color": "#DADADA", "--card-bg-color": "#12161B", "--card-border-color": "#202830", "--input-bg-color": "#12161B", "--input-border-color": "#202830", "--input-text-color": "#DADADA", "--btn-primary-bg-color": "#00B8D4", "--btn-primary-text-color": "#090C0F", "--btn-secondary-bg-color": "#202830", "--btn-secondary-text-color": "#DADADA", "--accent-color": "#00B8D4", "--label-text-color": "#B0B0B0", "--header-text-color": "#DADADA", "--digital-clock-text-color": "#00B8D4", "--digital-clock-shadow-color": "#00B8D4", "--current-date-text-color": "#B0B0B0", "--svg-icon-color": "#B0B0B0", "--modal-backdrop-color": "rgba(0,0,0,0.8)", "--loading-spinner-color": "#00B8D4", "--theme-menu-bg": "#12161B", "--theme-menu-text": "#DADADA", "--theme-menu-hover-bg": "#202830", "--theme-menu-shadow": "rgba(0,0,0,0.35)" }},
        "slate-glass": { name: "Slate Glass", isDark: true, font: 'Poppins', className: 'theme-slate-glass', colors: { "--bg-color": "#1E2229", "--text-color": "#EAEAEA", "--card-bg-color": "rgba(40,45,55,0.65)", "--card-border-color": "rgba(70,130,180,0.3)", "--input-bg-color": "rgba(45,50,60,0.7)", "--input-border-color": "rgba(70,130,180,0.35)", "--input-text-color": "#EAEAEA", "--btn-primary-bg-color": "#4682B4", "--btn-primary-text-color": "#FFFFFF", "--btn-secondary-bg-color": "rgba(50,55,65,0.7)", "--btn-secondary-text-color": "#EAEAEA", "--accent-color": "#4682B4", "--label-text-color": "#C0C0C0", "--header-text-color": "#F4F4F4", "--digital-clock-text-color": "#4682B4", "--digital-clock-shadow-color": "#4682B4", "--current-date-text-color": "#C0C0C0", "--svg-icon-color": "#C0C0C0", "--modal-backdrop-color": "rgba(0,0,0,0.6)", "--loading-spinner-color": "#4682B4", "--theme-menu-bg": "rgba(40,45,55,0.85)", "--theme-menu-text": "#EAEAEA", "--theme-menu-hover-bg": "rgba(50,55,65,0.85)", "--theme-menu-shadow": "rgba(0,0,0,0.3)" }},
        "terminal-retro-modern": { name: "Terminal Retro-Modern", isDark: true, font: 'monospace', className: 'theme-terminal-retro-modern', colors: { "--bg-color": "#000000", "--text-color": "#00FF00", "--card-bg-color": "#0A0A0A", "--card-border-color": "#00FF00", "--input-bg-color": "#050505", "--input-border-color": "#00FF00", "--input-text-color": "#00FF00", "--btn-primary-bg-color": "#00FF00", "--btn-primary-text-color": "#000000", "--btn-secondary-bg-color": "#222222", "--btn-secondary-text-color": "#00FF00", "--accent-color": "#00FF00", "--label-text-color": "#00FF00", "--header-text-color": "#00FF00", "--digital-clock-text-color": "#00FF00", "--digital-clock-shadow-color": "#00FF00", "--current-date-text-color": "#00FF00", "--svg-icon-color": "#00FF00", "--modal-backdrop-color": "rgba(0,0,0,0.7)", "--loading-spinner-color": "#00FF00", "--theme-menu-bg": "#0A0A0A", "--theme-menu-text": "#00FF00", "--theme-menu-hover-bg": "#1A1A1A", "--theme-menu-shadow": "rgba(0,0,0,0.25)" }}
    };

    function populateThemeSelector() {
        themeMenu.innerHTML = ''; 
        Object.keys(themes).forEach(themeKey => {
            const theme = themes[themeKey];
            const optionElement = document.createElement('a'); 
            optionElement.href = "#";
            optionElement.classList.add('theme-option');
            optionElement.textContent = theme.name;
            optionElement.dataset.theme = themeKey;
            optionElement.addEventListener('click', (e) => {
                e.preventDefault();
                applyTheme(themeKey);
                themeMenu.classList.remove('active');
            });
            themeMenu.appendChild(optionElement);
        });
    }

    function applyTheme(themeName) {
        const selectedTheme = themes[themeName];
        if (!selectedTheme) {
            // console.warn("Theme not found:", themeName, ". Defaulting to default-dark.");
            applyTheme("default-dark"); 
            return;
        }

        Object.values(themes).forEach(theme => {
            if (theme.className) root.classList.remove(theme.className);
            if (theme.font) document.body.classList.remove(`font-${theme.font.toLowerCase()}`);
        });
        // Remove all possible font classes before adding the new one
        document.body.classList.remove('font-inter', 'font-poppins', 'font-orbitron', 'font-roboto', 'font-monospace');


        root.classList.toggle('dark', selectedTheme.isDark);
        if (selectedTheme.className) root.classList.add(selectedTheme.className);
        
        if (selectedTheme.font) {
            document.body.classList.add(`font-${selectedTheme.font.toLowerCase()}`);
        } else {
            document.body.classList.add('font-inter'); 
        }

        for (const [key, value] of Object.entries(selectedTheme.colors)) {
            root.style.setProperty(key, value);
        }
        localStorage.setItem('ageCalculatorTheme', themeName);
    }
        
    function saveDobToLocalStorage() {
        if (dobDayInput.value && dobMonthInput.value && dobYearInput.value) { 
            localStorage.setItem('dobDay', dobDayInput.value);
            localStorage.setItem('dobMonth', dobMonthInput.value); 
            localStorage.setItem('dobYear', dobYearInput.value);
        }
        if (dobHourInput.value) localStorage.setItem('dobHour', dobHourInput.value);
        else localStorage.removeItem('dobHour'); 
        
        if (dobMinuteInput.value) localStorage.setItem('dobMinute', dobMinuteInput.value);
        else localStorage.removeItem('dobMinute'); 
    }

    function loadDobFromLocalStorage() {
        const savedYear = localStorage.getItem('dobYear');
        const savedMonth = localStorage.getItem('dobMonth'); 
        const savedDay = localStorage.getItem('dobDay');
        const savedHour = localStorage.getItem('dobHour'); 
        const savedMinute = localStorage.getItem('dobMinute'); 

        let dobLoaded = false;
        if (savedYear) {
            dobYearInput.value = savedYear; 
            if (savedMonth) { 
                dobMonthInput.value = savedMonth; 
                if (savedDay) {
                    dobDayInput.value = savedDay; 
                    if (savedHour) dobHourInput.value = savedHour;
                    if (savedMinute) dobMinuteInput.value = savedMinute;
                    dobLoaded = true; 
                }
            }
        }
        return dobLoaded;
    }
    
    function daysInMonth(monthIndex, year) { 
        return new Date(year, monthIndex + 1, 0).getDate();
    }
    function isLeapYear(year) {
        return (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0;
    }


    function calculatePreciseAge(bdt, now) {
        if (!bdt || bdt > now) { return null; }
        let years = now.getFullYear() - bdt.getFullYear();
        let months = now.getMonth() - bdt.getMonth();
        let days = now.getDate() - bdt.getDate();
        let hours = now.getHours() - bdt.getHours();
        let minutes = now.getMinutes() - bdt.getMinutes();
        let seconds = now.getSeconds() - bdt.getSeconds();

        if (seconds < 0) { seconds += 60; minutes--; }
        if (minutes < 0) { minutes += 60; hours--; }
        if (hours < 0) { hours += 24; days--; }
        if (days < 0) {
            months--;
            const prevMonthDate = new Date(now.getFullYear(), now.getMonth(), 0);
            days += prevMonthDate.getDate();
        }
        if (months < 0) { months += 12; years--; }
        if (years < 0) years = 0; 

        const totalMilliseconds = now - bdt;
        const totalSeconds = Math.floor(totalMilliseconds / 1000);
        return { years, months, days, hours, minutes, seconds, 
                 totalSeconds, 
                 totalMinutes: Math.floor(totalSeconds / 60), 
                 totalHours: Math.floor(totalSeconds / 3600), 
                 totalDays: Math.floor(totalSeconds / (3600*24)) };
    }

    function formatAgePart(value, unitSingular, unitPlural) {
        const label = value === 1 ? unitSingular : unitPlural;
        const block = document.createElement('div');
        block.classList.add('age-block');
        block.innerHTML = `
            <span class="age-value">${value}</span>
            <span class="age-label">${label}</span>`;
        return block.outerHTML;
    }
    
    function displayFormattedAge(ageObject, format) {
        if (!ageObject) {
            ageResultDiv.innerHTML = `<p class="text-center label-text col-span-full py-3 sm:py-4">Please select a valid past date and time of birth.</p>`;
            return;
        }
        let html = '';
        const { years, months, days, hours, minutes, seconds, totalSeconds, totalMinutes, totalHours, totalDays } = ageObject;
        ageResultDiv.innerHTML = ''; 

        switch (format) {
            case 'YMDHMS': // New: Years, Months, Days, Hours, Minutes, Seconds
                html += formatAgePart(years, 'Year', 'Years');
                html += formatAgePart(months, 'Month', 'Months');
                html += formatAgePart(days, 'Day', 'Days');
                html += formatAgePart(hours, 'Hour', 'Hours');
                html += formatAgePart(minutes, 'Minute', 'Minutes');
                html += formatAgePart(seconds, 'Second', 'Seconds');
                break;
            case 'YDHMS': // Updated: Years, Days, Hours, Minutes, Seconds
                html += formatAgePart(years, 'Year', 'Years');
                let remainingDaysAfterYears = totalDays;
                let tempBirth = new Date(birthDateTime); // Use actual birthDateTime
                for(let y=0; y < years; y++){
                    remainingDaysAfterYears -= isLeapYear(tempBirth.getFullYear()) ? 366 : 365;
                    tempBirth.setFullYear(tempBirth.getFullYear() + 1);
                }
                html += formatAgePart(remainingDaysAfterYears, 'Day', 'Days');
                html += formatAgePart(hours, 'Hour', 'Hours');
                html += formatAgePart(minutes, 'Minute', 'Minutes');
                html += formatAgePart(seconds, 'Second', 'Seconds');
                break;
            case 'MDHMS': // Months, Days, Hours, Minutes, Seconds (No change in logic needed from previous YMDHMS if Y is removed)
                const totalMonthsDisplay = years * 12 + months; // Total months
                html += formatAgePart(totalMonthsDisplay, 'Month', 'Months');
                html += formatAgePart(days, 'Day', 'Days'); // Remainder days after full months
                html += formatAgePart(hours, 'Hour', 'Hours');
                html += formatAgePart(minutes, 'Minute', 'Minutes');
                html += formatAgePart(seconds, 'Second', 'Seconds');
                break;
            case 'WDHMS':
                html += formatAgePart(Math.floor(totalDays / 7), 'Week', 'Weeks');
                html += formatAgePart(totalDays % 7, 'Day', 'Days');
                const wdhms_rem_sec = totalSeconds % (3600 * 24);
                html += formatAgePart(Math.floor(wdhms_rem_sec / 3600), 'Hour', 'Hours');
                html += formatAgePart(Math.floor((wdhms_rem_sec % 3600) / 60), 'Minute', 'Minutes');
                html += formatAgePart(wdhms_rem_sec % 60, 'Second', 'Seconds');
                break;
            case 'DHMS':
                html += formatAgePart(totalDays, 'Day', 'Days');
                const dhms_rem_sec = totalSeconds % (3600 * 24);
                html += formatAgePart(Math.floor(dhms_rem_sec / 3600), 'Hour', 'Hours');
                html += formatAgePart(Math.floor((dhms_rem_sec % 3600) / 60), 'Minute', 'Minutes');
                html += formatAgePart(dhms_rem_sec % 60, 'Second', 'Seconds');
                break;
            case 'HMS':
                html += formatAgePart(totalHours, 'Hour', 'Hours');
                const hms_rem_sec = totalSeconds % 3600;
                html += formatAgePart(Math.floor(hms_rem_sec / 60), 'Minute', 'Minutes');
                html += formatAgePart(hms_rem_sec % 60, 'Second', 'Seconds');
                break;
            case 'MS':
                html += formatAgePart(totalMinutes, 'Minute', 'Minutes');
                html += formatAgePart(totalSeconds % 60, 'Second', 'Seconds');
                break;
            case 'S':
                html += formatAgePart(totalSeconds, 'Second', 'Seconds');
                break;
            default:
                html = `<p class="text-center label-text col-span-full py-3 sm:py-4">Invalid format selected.</p>`;
        }
        ageResultDiv.innerHTML = html || `<p class="text-center label-text col-span-full py-3 sm:py-4">Calculating...</p>`;
    }


    function calculateAndDisplayCurrentAge() {
        if (!birthDateTime) {
            ageResultDiv.innerHTML = `<p class="text-center label-text col-span-full py-3 sm:py-4">Select your full date and time of birth to see your age.</p>`;
            return;
        }
        const now = new Date();
        if (birthDateTime > now) {
            ageResultDiv.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 col-span-full py-3 sm:py-4">Date and time of birth cannot be in the future.</p>`;
            if (ageCalculationInterval) { clearInterval(ageCalculationInterval); ageCalculationInterval = null; }
            return;
        }
        const ageObject = calculatePreciseAge(birthDateTime, now);
        displayFormattedAge(ageObject, formatSelect.value);
    }

    function startOrUpdateAgeCalculationInterval() {
        if (ageCalculationInterval) { clearInterval(ageCalculationInterval); }
        if (birthDateTime) {
            calculateAndDisplayCurrentAge(); 
            ageCalculationInterval = setInterval(calculateAndDisplayCurrentAge, 1000);
        } else {
            ageResultDiv.innerHTML = `<p class="text-center label-text col-span-full py-3 sm:py-4">Select your full date and time of birth to see your age.</p>`;
        }
    }

    function handleDobChange() {
        const dayStr = dobDayInput.value; 
        const monthStr = dobMonthInput.value; 
        const yearStr = dobYearInput.value; 
        const hourStr = dobHourInput.value; 
        const minuteStr = dobMinuteInput.value; 
        
        const year = parseInt(yearStr, 10);
        const monthNumInput = parseInt(monthStr, 10); 
        const day = parseInt(dayStr, 10);
        let hour, minute; 

        let parsedHour = parseInt(hourStr, 10);
        let parsedMinute = parseInt(minuteStr, 10);

        if (hourStr.trim() === "" && minuteStr.trim() === "") { hour = 0; minute = 0;
        } else {
            if (hourStr.trim() === "") hour = 0;
            else if (isNaN(parsedHour) || parsedHour < 0 || parsedHour > 23) {
                birthDateTime = null; if (ageCalculationInterval) clearInterval(ageCalculationInterval);
                ageResultDiv.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 col-span-full py-3 sm:py-4">Invalid birth hour (0-23).</p>`; return;
            } else hour = parsedHour;

            if (minuteStr.trim() === "") minute = 0;
            else if (isNaN(parsedMinute) || parsedMinute < 0 || parsedMinute > 59) {
                birthDateTime = null; if (ageCalculationInterval) clearInterval(ageCalculationInterval);
                ageResultDiv.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 col-span-full py-3 sm:py-4">Invalid birth minute (0-59).</p>`; return;
            } else minute = parsedMinute;
        }

        if (!yearStr || isNaN(year) || yearStr.length > 4 || year < 1 ) { 
            birthDateTime = null; if (ageCalculationInterval) clearInterval(ageCalculationInterval);
            ageResultDiv.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 col-span-full py-3 sm:py-4">Please enter a valid birth year (1-9999).</p>`; return;
        }
        
        if (!monthStr || isNaN(monthNumInput) || monthNumInput < 1 || monthNumInput > 12) { 
            birthDateTime = null; if (ageCalculationInterval) clearInterval(ageCalculationInterval);
            ageResultDiv.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 col-span-full py-3 sm:py-4">Please enter a valid birth month (1-12).</p>`; return;
        }
        const monthIndex = monthNumInput - 1; 

        if (!dayStr || isNaN(day) || day < 1 || day > 31) {
             birthDateTime = null; if (ageCalculationInterval) clearInterval(ageCalculationInterval);
            ageResultDiv.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 col-span-full py-3 sm:py-4">Please enter a valid birth day (1-31).</p>`; return;
        }

        if (dayStr && monthStr && yearStr) { 
            birthDateTime = new Date(year, monthIndex, day, hour, minute, 0, 0);

            if (isNaN(birthDateTime.getTime()) || 
                birthDateTime.getFullYear() !== year ||
                birthDateTime.getMonth() !== monthIndex ||
                birthDateTime.getDate() !== day) { 
                birthDateTime = null; if (ageCalculationInterval) clearInterval(ageCalculationInterval);
                ageResultDiv.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 col-span-full py-3 sm:py-4">Invalid date of birth selected (e.g., Feb 30).</p>`; return;
            }
            saveDobToLocalStorage();
            startOrUpdateAgeCalculationInterval();
        } else { 
            birthDateTime = null; if (ageCalculationInterval) clearInterval(ageCalculationInterval);
            ageResultDiv.innerHTML = `<p class="text-center label-text col-span-full py-3 sm:py-4">Please select a full, valid date and time of birth.</p>`;
        }
    }

    function updateClockAndDate() {
        const now = new Date();
        let hours = now.getHours();
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const seconds = now.getSeconds().toString().padStart(2, '0');
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12; 
        const hoursStr = hours.toString().padStart(2, '0');
        
        const monthsForDate = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        if (digitalClockDiv) digitalClockDiv.textContent = `${hoursStr}:${minutes}:${seconds} ${ampm}`;

        const day = now.getDate();
        const month = monthsForDate[now.getMonth()];
        const year = now.getFullYear();
        if (currentDateDiv) currentDateDiv.textContent = `${day} ${month} ${year}`;
    }

    function resetAllAgeCalculator() {
        dobDayInput.value = ''; 
        dobMonthInput.value = ''; 
        dobYearInput.value = ''; 
        dobHourInput.value = ''; 
        dobMinuteInput.value = ''; 
        birthDateTime = null;
        if (ageCalculationInterval) { clearInterval(ageCalculationInterval); ageCalculationInterval = null; }
        localStorage.removeItem('dobDay');
        localStorage.removeItem('dobMonth');
        localStorage.removeItem('dobYear');
        localStorage.removeItem('dobHour'); 
        localStorage.removeItem('dobMinute'); 
        ageResultDiv.innerHTML = `<p class="text-center label-text col-span-full py-3 sm:py-4">Select your full date and time of birth.</p>`;
        formatSelect.selectedIndex = 0; 
    }

    function openModal(modalElement) {
        if(modalElement) {
            modalElement.classList.remove('hidden', 'opacity-0');
            requestAnimationFrame(() => { // Ensures transition is applied after display:flex
                modalElement.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95'); // Start state for transition
                modalElement.querySelector('.modal-content').classList.add('opacity-100', 'scale-100'); // End state for transition
            });
        }
    }

    function closeModal(modalElement) {
         if(modalElement) {
            modalElement.querySelector('.modal-content').classList.add('opacity-0', 'scale-95');
            modalElement.querySelector('.modal-content').classList.remove('opacity-100', 'scale-100');
            modalElement.classList.add('opacity-0'); // Fade out the backdrop
            setTimeout(() => modalElement.classList.add('hidden'), 350); // Hide after transition
        }
    }

    function openDateDifferenceModalHandler() { 
        openModal(dateDifferenceModal); handleCalculateDifference(); 
    } 
    
    function closeDateDifferenceModalHandler() { 
        closeModal(dateDifferenceModal);
        if (differenceCalculationInterval) { clearInterval(differenceCalculationInterval); differenceCalculationInterval = null; }
    }

    function resetDateDifferenceModal() {
        startDateDayInput.value = ''; startDateMonthInput.value = ''; startDateYearInput.value = '';
        endDateDayInput.value = ''; endDateMonthInput.value = ''; endDateYearInput.value = '';
        startDateForDifferenceModal = null; // Reset stored start date
        differenceFormatSelect.selectedIndex = 0;
        if (differenceCalculationInterval) { clearInterval(differenceCalculationInterval); differenceCalculationInterval = null; }
        dateDifferenceResultDiv.innerHTML = `<p class="text-center label-text col-span-full py-3 sm:py-4">Enter two valid dates to see the difference.</p>`;
    }

    function calculateDateDifference(d1, d2) { 
        if (!d1 || !d2 || d1.getTime() >= d2.getTime()) return null;
        let years = d2.getFullYear() - d1.getFullYear();
        let months = d2.getMonth() - d1.getMonth();
        let days = d2.getDate() - d1.getDate();
        let hours = d2.getHours() - d1.getHours(); // Assuming 00:00 for dates if not specified
        let minutes = d2.getMinutes() - d1.getMinutes();
        let seconds = d2.getSeconds() - d1.getSeconds();


        if (seconds < 0) { seconds += 60; minutes--; }
        if (minutes < 0) { minutes += 60; hours--; }
        if (hours < 0) { hours += 24; days--; }
        if (days < 0) {
            months--;
            const prevMonthOfD2 = new Date(d2.getFullYear(), d2.getMonth(), 0);
            days += prevMonthOfD2.getDate();
        }
        if (months < 0) { months += 12; years--; }

        const totalMilliseconds = d2.getTime() - d1.getTime();
        const totalSeconds = Math.floor(totalMilliseconds / 1000);
        return { years, months, days, hours, minutes, seconds, totalSeconds, totalMinutes: Math.floor(totalSeconds / 60), totalHours: Math.floor(totalSeconds / 3600), totalDays: Math.floor(totalSeconds / (3600 * 24)) };
    }

    function displayDifference(diffObject, resultDiv, format, isCountdown = false, baseDateForYDHMS) {
        if (!diffObject) {
            resultDiv.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 col-span-full py-3 sm:py-4">${isCountdown ? 'Please select a valid future date and time.' : 'End Date must be after Start Date, or dates are invalid.'}</p>`;
            return;
        }
        let html = '';
        const { years, months, days, hours, minutes, seconds, totalSeconds, totalMinutes, totalHours, totalDays } = diffObject;
        resultDiv.innerHTML = ''; 
        switch (format) {
            case 'YMDHMS': // New: Years, Months, Days, Hours, Minutes, Seconds for difference/countdown
                html += formatAgePart(years, 'Year', 'Years');
                html += formatAgePart(months, 'Month', 'Months');
                html += formatAgePart(days, 'Day', 'Days');
                html += formatAgePart(hours, 'Hour', 'Hours');
                html += formatAgePart(minutes, 'Minute', 'Minutes');
                html += formatAgePart(seconds, 'Second', 'Seconds');
                break;
            case 'YDHMS':
                html += formatAgePart(years, 'Year', 'Years');
                let remainingDaysAfterYears = totalDays;
                let tempStart = new Date(baseDateForYDHMS); // Use the passed base date
                for(let y=0; y < years; y++){
                    remainingDaysAfterYears -= isLeapYear(tempStart.getFullYear()) ? 366 : 365;
                    tempStart.setFullYear(tempStart.getFullYear() + 1);
                }
                html += formatAgePart(remainingDaysAfterYears, 'Day', 'Days');
                html += formatAgePart(hours, 'Hour', 'Hours');
                html += formatAgePart(minutes, 'Minute', 'Minutes');
                html += formatAgePart(seconds, 'Second', 'Seconds');
                break;
            case 'MDHMS': 
                const totalMonthsDisplay = years * 12 + months;
                html += formatAgePart(totalMonthsDisplay, 'Month', 'Months');
                html += formatAgePart(days, 'Day', 'Days'); 
                html += formatAgePart(hours, 'Hour', 'Hours');
                html += formatAgePart(minutes, 'Minute', 'Minutes');
                html += formatAgePart(seconds, 'Second', 'Seconds');
                break;
            case 'WDHMS': 
                html += formatAgePart(Math.floor(totalDays / 7), 'Week', 'Weeks'); 
                html += formatAgePart(totalDays % 7, 'Day', 'Days'); 
                const wdhms_rem_sec = totalSeconds % (3600*24); 
                html += formatAgePart(Math.floor(wdhms_rem_sec/3600), 'Hour', 'Hours'); 
                html += formatAgePart(Math.floor((wdhms_rem_sec%3600)/60), 'Minute', 'Minutes'); 
                html += formatAgePart(wdhms_rem_sec%60, 'Second', 'Seconds'); 
                break;
            case 'DHMS': 
                html += formatAgePart(totalDays, 'Day', 'Days'); 
                const dhms_rem_sec = totalSeconds % (3600*24); 
                html += formatAgePart(Math.floor(dhms_rem_sec/3600), 'Hour', 'Hours'); 
                html += formatAgePart(Math.floor((dhms_rem_sec%3600)/60), 'Minute', 'Minutes'); 
                html += formatAgePart(dhms_rem_sec%60, 'Second', 'Seconds'); 
                break;
            case 'HMS': 
                html += formatAgePart(totalHours, 'Hour', 'Hours'); 
                const hms_rem_sec = totalSeconds % 3600; 
                html += formatAgePart(Math.floor(hms_rem_sec/60), 'Minute', 'Minutes'); 
                html += formatAgePart(hms_rem_sec%60, 'Second', 'Seconds'); 
                break;
            case 'MS': 
                html += formatAgePart(totalMinutes, 'Minute', 'Minutes'); 
                html += formatAgePart(totalSeconds % 60, 'Second', 'Seconds'); 
                break;
            case 'S': 
                html += formatAgePart(totalSeconds, 'Second', 'Seconds'); 
                break;
            default: html = `<p class="text-center label-text col-span-full py-3 sm:py-4">Invalid format selected.</p>`;
        }
        resultDiv.innerHTML = html || `<p class="text-center label-text col-span-full py-3 sm:py-4">Calculating...</p>`;
    }

    function getDateFromInputs(dayInput, monthInput, yearInput, defaultHour = 0, defaultMinute = 0) {
        const dayStr = dayInput.value;
        const monthStr = monthInput.value; 
        const yearStr = yearInput.value;

        if (!yearStr && !monthStr && !dayStr) return null; 

        const year = parseInt(yearStr, 10);
        const monthNumInput = parseInt(monthStr, 10); 
        const day = parseInt(dayStr, 10);

        if (!yearStr || isNaN(year) || year < 1 || year > 9999) return { error: "Invalid Year (1-9999)." };
        if (!monthStr || isNaN(monthNumInput) || monthNumInput < 1 || monthNumInput > 12) return { error: "Invalid Month (1-12)." };
        const monthIndex = monthNumInput - 1; 
        if (!dayStr || isNaN(day) || day < 1 || day > 31) return { error: "Invalid Day (1-31)." };
        
        const date = new Date(year, monthIndex, day, defaultHour, defaultMinute, 0, 0);
        if (isNaN(date.getTime()) || date.getFullYear() !== year || date.getMonth() !== monthIndex || date.getDate() !== day) {
            return { error: "Invalid date (e.g., Feb 30)." };
        }
        return date;
    }


    function handleCalculateDifference() {
        if (differenceCalculationInterval) { clearInterval(differenceCalculationInterval); differenceCalculationInterval = null; }

        const startDateResult = getDateFromInputs(startDateDayInput, startDateMonthInput, startDateYearInput);
        const endDateResult = getDateFromInputs(endDateDayInput, endDateMonthInput, endDateYearInput);

        if (!startDateResult && !endDateResult) { 
             dateDifferenceResultDiv.innerHTML = `<p class="text-center label-text col-span-full py-3 sm:py-4">Enter two valid dates to see the difference.</p>`;
             startDateForDifferenceModal = null; // Clear stored start date
             return;
        }
        
        let startDate, endDate;

        if (startDateResult && startDateResult.error) {
            dateDifferenceResultDiv.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 col-span-full py-3 sm:py-4">Start Date Error: ${startDateResult.error}</p>`; 
            startDateForDifferenceModal = null; return;
        } else if (startDateResult) {
            startDate = startDateResult;
            startDateForDifferenceModal = new Date(startDate); // Store for YDHMS calculation
        } else { 
            dateDifferenceResultDiv.innerHTML = `<p class="text-center label-text col-span-full py-3 sm:py-4">Please complete the Start Date.</p>`; 
            startDateForDifferenceModal = null; return;
        }

        if (endDateResult && endDateResult.error) {
            dateDifferenceResultDiv.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 col-span-full py-3 sm:py-4">End Date Error: ${endDateResult.error}</p>`; return;
        } else if (endDateResult) {
            endDate = endDateResult;
        } else { 
            dateDifferenceResultDiv.innerHTML = `<p class="text-center label-text col-span-full py-3 sm:py-4">Please complete the End Date.</p>`; return;
        }


        if (startDate && endDate) {
            if (startDate.getTime() >= endDate.getTime()) {
                dateDifferenceResultDiv.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 col-span-full py-3 sm:py-4">End Date must be after Start Date.</p>`; return;
            }
            const differenceObject = calculateDateDifference(startDate, endDate);
            displayDifference(differenceObject, dateDifferenceResultDiv, differenceFormatSelect.value, false, startDateForDifferenceModal);
        }
    }


    function openCountdownModalHandler() { 
        openModal(countdownModal); handleFutureDateInputChangeModal(); 
    }

    function closeCountdownModalHandler() {
        closeModal(countdownModal);
        if (countdownModalInterval) { clearInterval(countdownModalInterval); countdownModalInterval = null; }
    }
    
    function parseAndValidateFutureDateModal() {
        const dayStr = futureDateDayInputModal.value;
        const monthStr = futureDateMonthInputModal.value; 
        const yearStr = futureDateYearInputModal.value;
        const hourStr = futureTimeHourInputModal.value; 
        const minuteStr = futureTimeMinuteInputModal.value; 

        if (!yearStr && !monthStr && !dayStr && !hourStr && !minuteStr) { 
            countdownResultModalDiv.innerHTML = `<p class="text-center label-text col-span-full py-3 sm:py-4">Enter a future date and time to start the countdown.</p>`; return null;
        }
        
        const year = parseInt(yearStr, 10);
        const monthNumInput = parseInt(monthStr, 10); 
        const day = parseInt(dayStr, 10);
        let hour, minute; 

        let parsedHour = parseInt(hourStr, 10);
        let parsedMinute = parseInt(minuteStr, 10);

        if (hourStr.trim() === "" && minuteStr.trim() === "") { hour = 0; minute = 0; } 
        else { 
             if (hourStr.trim() === "") hour = 0; 
             else if (isNaN(parsedHour) || parsedHour < 0 || parsedHour > 23) {
                 countdownResultModalDiv.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 col-span-full py-3 sm:py-4">Invalid future hour (0-23).</p>`; return null;
             } else hour = parsedHour;

            if (minuteStr.trim() === "") minute = 0; 
            else if (isNaN(parsedMinute) || parsedMinute < 0 || parsedMinute > 59) {
                countdownResultModalDiv.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 col-span-full py-3 sm:py-4">Invalid future minute (0-59).</p>`; return null;
            } else minute = parsedMinute;
        }

        if (!yearStr || isNaN(year) || yearStr.length > 4 || year < 1) {
            countdownResultModalDiv.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 col-span-full py-3 sm:py-4">Please enter a valid future year (1-9999).</p>`; return null;
        }
        if (!monthStr || isNaN(monthNumInput) || monthNumInput < 1 || monthNumInput > 12) {
            countdownResultModalDiv.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 col-span-full py-3 sm:py-4">Please enter a valid future month (1-12).</p>`; return null;
        }
        const monthIndex = monthNumInput - 1; 

        if (!dayStr || isNaN(day) || day < 1 || day > 31) {
            countdownResultModalDiv.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 col-span-full py-3 sm:py-4">Please enter a valid future day (1-31).</p>`; return null;
        }

        const tempDate = new Date(year, monthIndex, day, hour, minute, 0, 0);

        if (isNaN(tempDate.getTime()) || tempDate.getFullYear() !== year || tempDate.getMonth() !== monthIndex || tempDate.getDate() !== day ) {
             countdownResultModalDiv.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 col-span-full py-3 sm:py-4">Invalid future date (e.g., Feb 30).</p>`; return null;
        }

        const now = new Date(); 
        if (tempDate.getTime() <= now.getTime()) {
            countdownResultModalDiv.innerHTML = `<p class="text-center text-red-500 dark:text-red-400 col-span-full py-3 sm:py-4">Future date & time must be after current time.</p>`; return null;
        }
        return tempDate;
    }

    function handleFutureDateInputChangeModal() {
        if (countdownModalInterval) { clearInterval(countdownModalInterval); countdownModalInterval = null; }
        futureDateTimeModal = parseAndValidateFutureDateModal(); 
        if (futureDateTimeModal) {
            updateCountdownDisplayModal(); 
            countdownModalInterval = setInterval(updateCountdownDisplayModal, 1000);
        }
    }

    function updateCountdownDisplayModal() {
        if (!futureDateTimeModal) { 
            if (countdownModalInterval) clearInterval(countdownModalInterval); countdownModalInterval = null; return;
        }
        const now = new Date();
        if (now.getTime() >= futureDateTimeModal.getTime()) {
            clearInterval(countdownModalInterval); countdownModalInterval = null;
            countdownResultModalDiv.innerHTML = `<div class="age-block col-span-full" style="grid-column: 1 / -1;"><span class="age-value">Time's Up!</span><span class="age-label">The countdown has ended.</span></div>`; return;
        }
        const differenceObject = calculateDateDifference(now, futureDateTimeModal);
        displayDifference(differenceObject, countdownResultModalDiv, countdownFormatSelectModal.value, true, new Date() /* base for YDHMS in countdown is 'now' */); 
    }

    function resetCountdownModalCalculator() {
        futureDateDayInputModal.value = ''; futureDateMonthInputModal.value = ''; futureDateYearInputModal.value = '';
        futureTimeHourInputModal.value = ''; futureTimeMinuteInputModal.value = ''; 
        futureDateTimeModal = null;
        if (countdownModalInterval) { clearInterval(countdownModalInterval); countdownModalInterval = null; }
        countdownResultModalDiv.innerHTML = `<p class="text-center label-text col-span-full py-3 sm:py-4">Enter a future date and time to start the countdown.</p>`;
        countdownFormatSelectModal.selectedIndex = 0;
    }

    /**
     * Sets up auto-jump functionality between input fields.
     * When the current input reaches its maxlength, focus moves to the next input.
     * @param {HTMLInputElement} currentInput The current input field.
     * @param {HTMLInputElement} nextInput The next input field to jump to.
     */
    function setupInputAutoJump(currentInput, nextInput) {
        if (!currentInput || !nextInput) {
            // console.warn("Auto-jump setup skipped: One or both input elements not found.");
            return;
        }

        const maxLength = parseInt(currentInput.getAttribute('maxlength'), 10);
        if (isNaN(maxLength) || maxLength <= 0) {
            // console.warn(`Auto-jump setup skipped for ${currentInput.id}: Invalid or missing maxlength attribute.`);
            return; // No valid maxlength, do nothing
        }

        currentInput.addEventListener('input', () => {
            if (currentInput.value.length >= maxLength) {
                // Ensure the value does not exceed maxlength for browsers that don't enforce it on type=number
                if (currentInput.value.length > maxLength) {
                    currentInput.value = currentInput.value.slice(0, maxLength);
                }
                nextInput.focus();
            }
        });
    }

    /**
     * Sets up backspace navigation between input fields.
     * When Backspace is pressed in an empty input, focus moves to the previous input,
     * and its last character is deleted.
     * @param {HTMLInputElement} currentInput The current input field.
     * @param {HTMLInputElement} previousInput The previous input field to jump to.
     */
    function setupInputBackspaceNavigation(currentInput, previousInput) {
        if (!currentInput || !previousInput) {
            // console.warn("Backspace navigation setup skipped: One or both input elements not found for", currentInput ? currentInput.id : 'unknown');
            return;
        }

        currentInput.addEventListener('keydown', (event) => {
            if (event.key === 'Backspace' && currentInput.value === '') {
                // Check if previousInput is indeed an input element and can be focused/modified
                if (typeof previousInput.focus === 'function' && 'value' in previousInput) {
                    event.preventDefault(); // Prevent default browser back navigation or other undesired effects
                    previousInput.focus();
                    // To make the backspace "continue" to the previous field and delete its last character
                    if (previousInput.value.length > 0) {
                        previousInput.value = previousInput.value.slice(0, -1);
                    }
                    // After modifying value, trigger input event for any other listeners (like handleDobChange)
                    previousInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
        });
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        // Assign DOM elements
        dobDayInput = document.getElementById('dobDay');
        dobMonthInput = document.getElementById('dobMonth'); 
        dobYearInput = document.getElementById('dobYear');
        dobHourInput = document.getElementById('dobHour');
        dobMinuteInput = document.getElementById('dobMinute');
        formatSelect = document.getElementById('formatSelect');
        ageResultDiv = document.getElementById('ageResult');
        digitalClockDiv = document.getElementById('digitalClock');
        currentDateDiv = document.getElementById('currentDateDisplay');
        resetButton = document.getElementById('resetButton');
        themeToggleButton = document.getElementById('themeToggleButton'); 
        themeMenu = document.getElementById('themeMenu'); 
        openDateDifferenceModalButton = document.getElementById('openDateDifferenceModalButton');
        dateDifferenceModal = document.getElementById('dateDifferenceModal');
        closeDateDifferenceModalButton = document.getElementById('closeDateDifferenceModalButton');
        startDateDayInput = document.getElementById('startDateDay');
        startDateMonthInput = document.getElementById('startDateMonth'); 
        startDateYearInput = document.getElementById('startDateYear');
        endDateDayInput = document.getElementById('endDateDay');
        endDateMonthInput = document.getElementById('endDateMonth'); 
        endDateYearInput = document.getElementById('endDateYear');
        resetDateDifferenceButton = document.getElementById('resetDateDifferenceButton');
        dateDifferenceResultDiv = document.getElementById('dateDifferenceResult');
        differenceFormatSelect = document.getElementById('differenceFormatSelect');
        openCountdownModalButton = document.getElementById('openCountdownModalButton');
        countdownModal = document.getElementById('countdownModal');
        closeCountdownModalButton = document.getElementById('closeCountdownModalButton');
        futureDateDayInputModal = document.getElementById('futureDateDayModal');
        futureDateMonthInputModal = document.getElementById('futureDateMonthInputModal'); 
        futureDateYearInputModal = document.getElementById('futureDateYearModal');
        futureTimeHourInputModal = document.getElementById('futureTimeHourInputModal');
        futureTimeMinuteInputModal = document.getElementById('futureTimeMinuteInputModal');
        countdownFormatSelectModal = document.getElementById('countdownFormatSelectModal');
        countdownResultModalDiv = document.getElementById('countdownResultModal');
        resetCountdownModalButton = document.getElementById('resetCountdownModalButton');

        // Add event listeners
        [dobDayInput, dobMonthInput, dobYearInput, dobHourInput, dobMinuteInput].forEach(el => el.addEventListener('input', handleDobChange));
        formatSelect.addEventListener('change', () => { if (birthDateTime) calculateAndDisplayCurrentAge(); });
        resetButton.addEventListener('click', resetAllAgeCalculator);
        
        if (themeToggleButton && themeMenu) {
            themeToggleButton.addEventListener('click', (event) => { event.stopPropagation(); themeMenu.classList.toggle('active'); });
            document.addEventListener('click', (event) => { if (themeMenu.classList.contains('active') && !themeMenu.contains(event.target) && event.target !== themeToggleButton) themeMenu.classList.remove('active'); });
        }

        openDateDifferenceModalButton.addEventListener('click', openDateDifferenceModalHandler);
        closeDateDifferenceModalButton.addEventListener('click', closeDateDifferenceModalHandler);
        dateDifferenceModal.addEventListener('click', (event) => { if (event.target === dateDifferenceModal) closeDateDifferenceModalHandler(); });
        resetDateDifferenceButton.addEventListener('click', resetDateDifferenceModal);
        [startDateDayInput, startDateMonthInput, startDateYearInput, endDateDayInput, endDateMonthInput, endDateYearInput, differenceFormatSelect].forEach((el) => {
            if (el) { el.addEventListener('input', handleCalculateDifference); el.addEventListener('change', handleCalculateDifference); }
        });

        openCountdownModalButton.addEventListener('click', openCountdownModalHandler); 
        closeCountdownModalButton.addEventListener('click', closeCountdownModalHandler);
        countdownModal.addEventListener('click', (event) => { if (event.target === countdownModal) closeCountdownModalHandler(); });
        resetCountdownModalButton.addEventListener('click', resetCountdownModalCalculator);
        [futureDateDayInputModal, futureDateMonthInputModal, futureDateYearInputModal, futureTimeHourInputModal, futureTimeMinuteInputModal, countdownFormatSelectModal].forEach((el) => {
            if (el) { el.addEventListener('input', handleFutureDateInputChangeModal); el.addEventListener('change', handleFutureDateInputChangeModal); }
        });

        // Setup auto-jump (forward) for date inputs
        // Main DOB inputs
        setupInputAutoJump(dobDayInput, dobMonthInput);
        setupInputAutoJump(dobMonthInput, dobYearInput);
        setupInputAutoJump(dobYearInput, dobHourInput); 
        setupInputAutoJump(dobHourInput, dobMinuteInput);

        // Date Difference Modal - Start Date
        setupInputAutoJump(startDateDayInput, startDateMonthInput);
        setupInputAutoJump(startDateMonthInput, startDateYearInput);

        // Date Difference Modal - End Date
        setupInputAutoJump(endDateDayInput, endDateMonthInput);
        setupInputAutoJump(endDateMonthInput, endDateYearInput);

        // Countdown Modal - Future Date
        setupInputAutoJump(futureDateDayInputModal, futureDateMonthInputModal);
        setupInputAutoJump(futureDateMonthInputModal, futureDateYearInputModal);
        setupInputAutoJump(futureDateYearInputModal, futureTimeHourInputModal); 
        setupInputAutoJump(futureTimeHourInputModal, futureTimeMinuteInputModal);
        
        // Setup backspace navigation (backward)
        // Main DOB inputs
        setupInputBackspaceNavigation(dobMinuteInput, dobHourInput);
        setupInputBackspaceNavigation(dobHourInput, dobYearInput);
        setupInputBackspaceNavigation(dobYearInput, dobMonthInput);
        setupInputBackspaceNavigation(dobMonthInput, dobDayInput);

        // Date Difference Modal - Start Date
        setupInputBackspaceNavigation(startDateYearInput, startDateMonthInput);
        setupInputBackspaceNavigation(startDateMonthInput, startDateDayInput);
        
        // Date Difference Modal - End Date
        setupInputBackspaceNavigation(endDateYearInput, endDateMonthInput);
        setupInputBackspaceNavigation(endDateMonthInput, endDateDayInput);

        // Countdown Modal - Future Date
        setupInputBackspaceNavigation(futureTimeMinuteInputModal, futureTimeHourInputModal);
        setupInputBackspaceNavigation(futureTimeHourInputModal, futureDateYearInputModal);
        setupInputBackspaceNavigation(futureDateYearInputModal, futureDateMonthInputModal);
        setupInputBackspaceNavigation(futureDateMonthInputModal, futureDateDayInputModal);
        
        // Initialize
        populateThemeSelector(); 
        const savedTheme = localStorage.getItem('ageCalculatorTheme') || 'carbon-matte'; 
        applyTheme(savedTheme); 
        
        if (loadDobFromLocalStorage()) handleDobChange(); 
        else ageResultDiv.innerHTML = `<p class="text-center label-text col-span-full py-3 sm:py-4">Select your full date and time of birth.</p>`;
        
        updateClockAndDate(); 
        setInterval(updateClockAndDate, 1000); 
    });
    </script>
</body>
</html>
